# Tasks Manager

## Введение
_<Вставьте сюда трогательную историю о дружбе и взаимопомощи>_

Поэтому _<имя персонажа>_ теперь предстоит написать web API для управления задачами.

## Общее описание задачи
Необходимо реализовать web API для управления сущностями в соответствии с требованиями.

|   Код   |                                       Название                                       |                Описание                 |
|---------|--------------------------------------------------------------------------------------|-----------------------------------------|
| ENT-001 | [Проекты](#ent-001-Проекты)                                                          | Требования к структуре сущности Проект  |
| ENT-002 | [Задачи](#ent-002-Задачи)                                                            | Требования к структуре сущности Задача  |
| ENT-003 | [Теги](#ent-003-Теги)                                                                | Требования к структуре сущности Тег     |
| TCH-001 | [Разделение по слоям](#tch-001-Разделение-по-слоям)                                  | Требование к разделению кода            |
| TCH-002 | [Использование IoC и DI](#tch-002-Использование-ioc-и-di)                            | Требование к использованию подходов     |
| TCH-003 | [Реализация data access](#tch-003-Реализация-data-access)                            | Требование к использованию подходов     |
| TCH-004 | [Документация API](#tch-004-Документация-api)                                        | Требование к реализации документации    |
| TCH-005 | [Преобразования Entities ⇄ ViewModels](#tch-005-Преобразования-entities--viewmodels) | Требование к использованию AutoMapper   |
| TCH-006 | [Ответы сервера](#tch-006-Ответы-сервера)                                            | Требование к используемым кодам ответов |
| TCH-007 | [Структура проектов](#tch-007-Структура-проектов)                                    | Требование к организации файлов         |

Проект можно реализовать полностью самостоятельно, либо воспользоваться проектом из [репозитория tasks-manager-init-repo](https://github.com/ikit-mita/tasks-manager-init-repo) для старта работы.

## Описание сущностей
### Заметки
  + Свойство "только для чтения" - его нельзя задать напрямую при создании и редактировании

### ENT-001 Проекты

#### Свойства
  + Название
    + строка
    + обязательное
    + ограничение на длину: 64 символа
  + Описание
    + строка
    + ограничение на длину: 2048 символа
  + Количество открытых задач (которые не в статусе Completed)
    + число
    + только для чтения

#### Операции
  + Просмотр списка (GET /api/projects)
    + Постраничный вывод (paging) и сортировка по любому свойству (sorting)
    + Фильтрация
      + Название - "начинается с"
      + Количество открытых задач - "от ... до"
  + Создание (POST /api/projects)
  + Просмотр (GET /api/projects/{projectId})
  + Обновление (PUT /api/projects/{projectId})
  + Удаление (DELETE /api/projects/{projectId})
    + Запрещено удалять проекты, в которых есть задачи

### ENT-002 Задачи

#### Свойства
  + Название
    + строка
    + обязательное
    + ограничение на длину: 64 символа
  + Описание
    + строка
    + ограничение на длину: 4096 символа
  + Крайний срок (due date)
    + Дата
  + Статус
    + перечисление
      + Создана (Created)
      + Выполняется (InProgress)
      + Отложена (Posponded)
      + Завершена (Completed)
    + обязательное
  + Теги
    + список строк
  + Проект
    + ссылка на проект
    + обязательное
  + Дата создания
    + дата
    + обязательное
    + только для чтения
  + Дата завершения
    + дата
    + только для чтения

#### Операции
  + Просмотр списка (GET /api/tasks)
    + Постраничный вывод (paging) и сортировка по любому свойству (sorting)
    + Фильтрация
      + Название - "начинается с"
      + Крайний срок - "от ... до"
      + Дата создания - "от ... до"
      + Дата завершения - "от ... до"
      + Статус - "равен"
      + Проект - "равен"
      + Тег - "содержит", т.е. задачи, у которых есть переданный тег
      + Есть Крайний срок - "да/нет"
  + Создание (POST /api/tasks)
    + установить статус Created
    + установить свойство Дата создания
  + Просмотр (GET /api/tasks/{taskId})
  + Обновление (PUT /api/tasks/{taskId})
    + При изменении статуса на Completed выставить свойство Дата завершения
  + Удаление (DELETE /api/tasks/{taskId})
  + Добавить тег к задаче (PUT /api/tasks/{taskId}/tags/{tag})
    + Если такого тега нету в системе - создать его
    + Если такой тег уже есть в задаче - ничего не делать
  + Удалить тег из задачи (DELETE /api/tasks/{taskId}/tags/{tag})

### ENT-003 Теги

#### Свойства
  + Название
    + строка
    + обязательное
    + ограничение на длину: 32 символа
  + Количество задач
    + число
    + только для чтения
  + Количество открытых задач (которые не в статусе Completed)
    + число
    + только для чтения

#### Операции
  + Просмотр списка (GET /api/tags)
    + Постраничный вывод (paging) и сортировка по любому свойству (sorting)
    + Фильтрация
      + Название - "начинается с"
  + Удаление (DELETE /api/tags/{tag})
    + Если тег используется в задачах - удалить из задач

## Технические требования

### TCH-001 Разделение по слоям
  - Controllers
    + получает запросы от клиента
    + валидирует данные
    + передает данные в слой доступа к данным
    + обрабатывает оговоренные исключения
    + отправляет ответ клиенту
    + оперирует моделями представления (view models)
  - Data Access
    + делает запросы в БД
    + преобразует модели данных (entities) в модели представлений (view models)
    + содержит бизнес-логику приложения
    + состоит из
      * контракт (описание интерфейсов и исключений)
      * реализация
  - Db
    + описывает базу данных
    + содержит классы и методы для работы с БД
    + содержит миграции

### TCH-002 Использование IoC и DI
  1. Явное создание сущностей при помощи ключевого слова `new` разрешено только для view models, entities и exceptions. Остальные сущности проекта (commands, queries, controllers, DB context, etc.) должны быть подключены в логику при помощи DI
  2. Взаимодействия слоев приложения должно осуществляться при помощи интерфейсов, где это возможно. Запрещено использовать конкретные типы для commands и queries.

### TCH-003 Реализация data access
  1. Для запросов в БД использовать только асинхронные операции (ToListAsync, CountAsync, FirstOrDefaultAsync, etc.)
  1. При реализации DA слоя использовать подход CQRS
    1. Операции работы с данными разделены на получение данных (запросы - queries) и изменение данных (команды - commands)
    1. Каждая операция реализуется в виде отдельного класса
    1. Query содержит 1 метод RunAsync
    1. Command содержит 1 метод ExecuteAsync
  1. Для всех ожидаемых исключительных ситуаций необходимо создать отдельные типы исключений. Например, для требования "Запрещено удалять проекты, в которых есть задачи" команда удаления проекта должна кинуть `CannotDeleteProjectWithTasksException`, если в удаляемом проекте есть задачи

### TCH-004 Документация API
  1. Документация доступна по адресу `/api-docs`
  2. Документация содержит описание всех доступных запросов
  3. Документация содержит описание моделей запросов от ответов и возможные коды ответов
Для создания страницы документации можно использовать любую библиотеку. В разделе ["Дополнительная информация"](#Дополнительная-информация) есть ссылка на описание подключения swagger.

### TCH-005 Преобразования Entities ⇄ ViewModels
В слое DA будет производиться преобразование entities во view models.
  1. Для преобразований подключить библиотеку AutoMapper
  2. При запросе в БД модели должны преобразовываться на стороне БД, т.е. результатом выполнения запроса должен быть view models

### TCH-006 Ответы сервера
  1. Успешное обновление, получение - 200
  2. Успешное создание - 201 + правильный заголовок `Location` (в заголовке должен быть адрес, по которому доступна созданная сущность)
  3. Успешное удаление или несуществующая сущность при удалении - 204
  4. Несуществующая сущность при получении и редактировании - 404
  5. Ошибка валидации при создании, редактировании и удалении - 400

### TCH-007 Структура проектов
Группировку файлов в проектах осуществлять по сущностям, с которыми взаимодействуют классы. Например:
  - DataAccess
    - Prejects
      + ICreateProjectCommand
      + IProjectQuery
      + ...
    - Tasks
      + ...
    - ...
  - ViewModels
    - Projects
      + ProjectReSponse
      + ProjectFilter
      + CreateProjectRequest
      + ...
     - Tasks
      + ...

## Дополнительная информация
  + [Создание проекта Web API](https://docs.microsoft.com/en-us/aspnet/core/tutorials/first-web-api)
  + [Описание класса Startup](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/startup)
  + [Описание маршрутизации в MVC](https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/routing)
  + [Как данные из запроса превращаются в параметры](https://docs.microsoft.com/en-us/aspnet/core/mvc/models/model-binding)
  + [Встроенные механизмы валидации](https://docs.microsoft.com/en-us/aspnet/core/mvc/models/validation)
  + [Подключение документации (Help Page)](https://docs.microsoft.com/en-us/aspnet/core/tutorials/web-api-help-pages-using-swagger)
  + [CQRS](http://andrey.moveax.ru/post/patterns-cqrs-part1-introducing)
  + [How to setup Automapper in ASP.NET Core](https://stackoverflow.com/a/40275196)
  + [AutoMapper Getting started](https://github.com/AutoMapper/AutoMapper/wiki)
  + [HTTP Code Statuses](https://httpstatuses.com/)
